# Lesson 008 - Docker Swarm and High Availability

Hello dockers,

In this lesson we will create a Swarm cluster and run services across multiple nodes for high availability.

## 1. Create Swarm Cluster

1. Open Docker Playground: <https://labs.play-with-docker.com/>
2. Create **three instances**.
3. On the first node, initialize the cluster:

```bash
docker swarm init --advertise-addr <manager-ip>
```

4. Copy the `docker swarm join --token ...` command generated by the manager.
5. Run that command on node 2 and node 3.

List cluster nodes:

```bash
docker node ls
```

Promote workers to managers (optional for this lab):

```bash
docker node update --role manager node2
docker node update --role manager node3
```

---

## 2. Create Overlay Network

```bash
docker network create ntw_redis --driver=overlay
docker network ls
```

---

## 3. Create Redis Service

```bash
docker service create -d --name redisserver --network ntw_redis -p 6379:6379 redis
docker service ls
docker service ps redisserver
```

---

## 4. Create API Service with Replicas

```bash
docker service create --replicas 3 --name dck-api -p 8001:80 -d --network ntw_redis -e REDIS_HOST=redisserver:6379 renatomatos79/apis:core-docker-api-1.1
docker service ls
docker service ps dck-api
```

To remove a service:

```bash
docker service rm dck-api
```

---

## 5. Validate from Different Nodes

From node 1:

```bash
curl http://localhost:8001/products
```

From node 3:

```bash
curl http://localhost:8001/products
```

Update cache and check response:

```bash
curl -X PUT http://localhost:8001/products/products -H "content-type: application/json" -d "[{\"Id\":1,\"Name\":\"From cache\",\"Price\":1.5}]"
curl http://localhost:8001/products
```

If responses are consistent across nodes, your cluster setup is working as expected.
